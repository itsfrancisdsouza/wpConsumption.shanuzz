<!DOCTYPE html>
<html lang="en">
<head>
    <title>Salon Client Consultation & Product Consumption Form</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <!-- Google Fonts - Roboto Condensed -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Content Security Policy - Uncomment for production -->
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src https://docs.google.com https://script.google.com https://*.googleusercontent.com;"> -->
    <style>
        /* CSS Variables for Amazon-like theming */
        :root {
            --lk-golden: 1.618;
            --lk-base: 15px;
            --lk-space-xs: calc(var(--lk-base) / var(--lk-golden) / var(--lk-golden));
            --lk-space-sm: calc(var(--lk-base) / var(--lk-golden));
            --lk-space-md: var(--lk-base);
            --lk-space-lg: calc(var(--lk-base) * var(--lk-golden));
            --lk-space-xl: calc(var(--lk-base) * var(--lk-golden) * var(--lk-golden));
            --lk-space-2xl: calc(var(--lk-base) * var(--lk-golden) * var(--lk-golden) * var(--lk-golden));
            --lk-text-caption: calc(var(--lk-base) / var(--lk-golden) / var(--lk-golden));
            --lk-text-label: calc(var(--lk-base) / var(--lk-golden));
            --lk-text-body: 16px; /* Amazon body size */
            --lk-text-subtitle: 18px; /* Amazon subtitle size */
            --lk-text-title: 24px; /* Amazon title size */
            --lk-text-display: calc(var(--lk-base) * var(--lk-golden) * var(--lk-golden) * var(--lk-golden));
            --lk-radius-sm: 7px;
            --lk-radius-md: 10px;
            --lk-radius-lg: 14px;
            --lk-primary: #FF9900; /* Amazon accent "Error Text Orange" */
            --lk-primary-light: #FFB84D; /* lighter yellow for hover */
            --lk-secondary: #06B6D4;
            --lk-accent: #F59E0B;
            --lk-surface: #FFFFFF;
            --lk-surface-variant: #F7F7F7;
            --lk-surface-container: #F1F5F9;
            --lk-outline: #E5E7EB; /* light divider */
            --lk-outline-variant: #D1D5DB;
            --lk-on-surface: #111111; /* very dark text */
            --lk-on-surface-variant: #555555; /* secondary text */
            --lk-success: #10B981;
            --lk-error: #EF4444;
            --lk-sage-green: #87A96B;
            --lk-sage-green-light: #9BB77D;
            --lk-sage-green-bg: #F0F4EC;
            
            /* Animation durations */
            --lk-transition-fast: 0.15s;
            --lk-transition-normal: 0.2s;
            --lk-transition-slow: 0.3s;
            
            /* Z-index layers */
            --lk-z-dropdown: 1000;
            --lk-z-toast: 9999;
            --lk-z-modal: 10000;
        }

        /* Reset and base styles */
        html { 
            box-sizing: border-box; 
            scroll-behavior: smooth;
        }
        *, *:before, *:after { 
            box-sizing: inherit; 
        }

        body {
            font-family: 'Roboto Condensed', 'sans-serif-condensed', Roboto, system-ui, sans-serif;
            font-size: var(--lk-text-body);
            line-height: var(--lk-golden);
            background: var(--lk-surface-variant);
            color: var(--lk-on-surface);
            min-height: 100vh;
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Container and layout */
        .container {
            max-width: 100%;
            margin: 0;
            padding: var(--lk-space-xl) var(--lk-space-md);
            background: var(--lk-surface);
            border-radius: 0;
            box-shadow: none;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: var(--lk-space-xl);
            border-bottom: 1px solid var(--lk-outline);
            padding-bottom: var(--lk-space-md);
        }

        .title {
            font-size: var(--lk-text-title);
            font-weight: 700;
            color: var(--lk-on-surface);
            margin-bottom: var(--lk-space-xs);
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: var(--lk-text-subtitle);
            color: var(--lk-on-surface-variant);
            font-weight: 400;
        }

        /* Section styles */
        .section {
            margin-bottom: var(--lk-space-xl);
            padding: var(--lk-space-md);
            background: var(--lk-surface);
            border: 1px solid var(--lk-outline-variant);
            border-radius: var(--lk-radius-md);
            box-shadow: none;
        }

        .consent-section {
            margin-bottom: var(--lk-space-xl);
            padding: var(--lk-space-lg);
            background: var(--lk-surface);
            border: 1px solid var(--lk-outline);
            border-radius: var(--lk-radius-md);
            box-shadow: none;
        }

        .signature-section {
            margin-bottom: var(--lk-space-xl);
            padding: var(--lk-space-lg);
            background: var(--lk-surface);
            border: 1px solid var(--lk-outline);
            border-radius: var(--lk-radius-md);
            box-shadow: none;
        }

        .section-title {
            font-size: 17px;
            font-weight: 700;
            color: var(--lk-on-surface);
            margin-bottom: var(--lk-space-md);
            padding-bottom: var(--lk-space-xs);
            border-bottom: 2px solid var(--lk-outline);
            display: flex;
            align-items: center;
            gap: var(--lk-space-sm);
        }

        .consent-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--lk-on-surface);
            margin-bottom: var(--lk-space-lg);
            text-align: center;
            padding-bottom: var(--lk-space-sm);
            border-bottom: 2px solid var(--lk-outline);
        }

        .signature-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--lk-on-surface);
            margin-bottom: var(--lk-space-lg);
            text-align: center;
            padding-bottom: var(--lk-space-sm);
            border-bottom: 2px solid var(--lk-outline);
        }

        .consent-content {
            font-size: var(--lk-text-body);
            line-height: 1.6;
            color: var(--lk-on-surface);
            margin-bottom: var(--lk-space-lg);
        }

        .consent-item {
            margin-bottom: var(--lk-space-md);
            padding-left: var(--lk-space-sm);
            position: relative;
        }

        .consent-item:before {
            content: "•";
            color: var(--lk-primary);
            font-weight: bold;
            position: absolute;
            left: 0;
            top: 0;
        }

        .consent-agreement {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--lk-space-lg);
            margin-top: var(--lk-space-lg);
            padding: var(--lk-space-md);
            background: white;
            border-radius: var(--lk-radius-sm);
            border: 1px solid var(--lk-outline-variant);
        }

        .consent-option {
            display: flex;
            align-items: center;
            gap: var(--lk-space-sm);
            cursor: pointer;
            padding: var(--lk-space-sm) var(--lk-space-md);
            border-radius: var(--lk-radius-sm);
            transition: background-color var(--lk-transition-normal);
        }

        .consent-option:hover {
            background: var(--lk-surface-variant);
        }

        .consent-radio {
            width: 20px;
            height: 20px;
            accent-color: var(--lk-primary);
        }

        .consent-label {
            font-weight: 500;
            color: var(--lk-on-surface);
        }

        /* Signature Pad Styles */
        .signature-container {
            text-align: center;
            margin-bottom: var(--lk-space-lg);
        }

        .signature-instructions {
            font-size: var(--lk-text-body);
            color: var(--lk-on-surface-variant);
            margin-bottom: var(--lk-space-md);
        }

        .signature-pad-wrapper {
            position: relative;
            border: 2px dashed var(--lk-outline);
            border-radius: var(--lk-radius-md);
            background: var(--lk-surface-variant);
            margin: 0 auto var(--lk-space-md);
            max-width: 400px;
        }

        .signature-pad {
            display: block;
            width: 100%;
            height: 150px;
            border: none;
            border-radius: var(--lk-radius-md);
            background: transparent;
            cursor: crosshair;
            position: relative;
            z-index: 1;
            /* Performance optimizations */
            touch-action: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        .signature-controls {
            display: flex;
            justify-content: center;
            gap: var(--lk-space-md);
            flex-wrap: wrap;
        }

        .signature-btn {
            padding: var(--lk-space-sm) var(--lk-space-md);
            border: 1px solid var(--lk-outline-variant);
            border-radius: var(--lk-radius-sm);
            background: white;
            color: var(--lk-on-surface);
            cursor: pointer;
            font-size: var(--lk-text-caption);
            transition: all var(--lk-transition-normal);
        }

        .signature-btn:hover {
            background: var(--lk-primary);
            color: white;
        }

        .signature-status {
            margin-top: var(--lk-space-md);
            padding: var(--lk-space-sm);
            border-radius: var(--lk-radius-sm);
            text-align: center;
            font-size: var(--lk-text-caption);
            display: none;
        }

        .signature-status.signed {
            background: #ECFDF5;
            color: var(--lk-success);
            border: 1px solid var(--lk-success);
            display: block;
        }

        .signature-status.empty {
            background: #FEF2F2;
            color: var(--lk-error);
            border: 1px solid var(--lk-error);
            display: block;
        }

        /* Photo Upload Styles */
        .photo-section {
            margin-top: var(--lk-space-lg);
            border-top: 1px solid var(--lk-outline-variant);
            padding-top: var(--lk-space-lg);
        }

        .photo-upload-box {
            border: 2px dashed var(--lk-outline);
            border-radius: var(--lk-radius-md);
            padding: var(--lk-space-lg);
            text-align: center;
            background: var(--lk-surface-variant);
            transition: all var(--lk-transition-normal);
            cursor: pointer;
            position: relative;
            max-width: 400px;
            margin: 0 auto;
        }

        .photo-upload-box:hover {
            border-color: var(--lk-primary);
            background: rgba(255, 153, 0, 0.02);
        }

        .photo-upload-box.has-photo {
            border-color: var(--lk-success);
            background: #ECFDF5;
        }

        .photo-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: var(--lk-radius-sm);
            margin-bottom: var(--lk-space-sm);
            display: none;
        }

        .photo-upload-text {
            font-size: var(--lk-text-body);
            color: var(--lk-on-surface-variant);
            margin-bottom: var(--lk-space-sm);
        }

        .photo-upload-icon {
            font-size: 2rem;
            color: var(--lk-primary);
            margin-bottom: var(--lk-space-sm);
        }

        .photo-controls {
            display: flex;
            justify-content: center;
            gap: var(--lk-space-sm);
            margin-top: var(--lk-space-sm);
        }

        .photo-btn {
            padding: var(--lk-space-xs) var(--lk-space-sm);
            border: 1px solid var(--lk-primary);
            border-radius: var(--lk-radius-sm);
            background: white;
            color: var(--lk-primary);
            cursor: pointer;
            font-size: var(--lk-text-caption);
            transition: all var(--lk-transition-normal);
        }

        .photo-btn:hover {
            background: var(--lk-primary);
            color: white;
        }

        .photo-btn.remove {
            border-color: var(--lk-error);
            color: var(--lk-error);
        }

        .photo-btn.remove:hover {
            background: var(--lk-error);
            color: white;
        }

        /* Grid layouts */
        .grid-1 {
            display: grid;
            gap: var(--lk-space-md);
            grid-template-columns: 1fr;
        }
        .grid-2 { 
            display: grid;
            gap: var(--lk-space-md);
            grid-template-columns: 1fr; 
        }

        .quantity-unit-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--lk-space-sm);
        }

        /* Form fields */
        .field {
            margin-bottom: var(--lk-space-sm);
            position: relative;
        }

        .label {
            display: block;
            font-size: 15px;
            font-weight: 700;
            color: var(--lk-on-surface);
            margin-bottom: var(--lk-space-xs);
        }

        .required { 
            color: var(--lk-error); 
            margin-left: 2px; 
        }

        .input,
        .textarea,
        .select {
            width: 100%;
            min-height: 44px;
            padding: 12px;
            border: 1px solid var(--lk-outline-variant);
            border-radius: 10px;
            font-size: 16px;
            background: var(--lk-surface);
            color: var(--lk-on-surface);
            transition: border-color var(--lk-transition-normal), box-shadow var(--lk-transition-normal);
            font-family: inherit;
        }

        .input[readonly] {
            background: var(--lk-surface-variant);
            color: var(--lk-on-surface-variant);
            font-weight: 500;
        }

        /* Remove spinner controls from number inputs */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        .input:focus,
        .textarea:focus,
        .select:focus {
            outline: none;
            border-color: var(--lk-primary);
            box-shadow: 0 0 0 2px rgba(255,153,0,0.25);
        }

        .input.error,
        .textarea.error,
        .select.error {
            border-color: var(--lk-error);
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.1);
        }

        .textarea { 
            resize: vertical; 
            min-height: 64px; 
        }

        .error-message {
            color: var(--lk-error);
            font-size: var(--lk-text-caption);
            margin-top: 4px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--lk-space-xs);
            margin-top: 4px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px;
            border-radius: var(--lk-radius-sm);
            font-size: 1rem;
            min-height: 36px;
            user-select: none;
            cursor: pointer;
        }
        .checkbox-item:hover { 
            background: var(--lk-surface-container); 
        }
        .checkbox { 
            width: 22px; 
            height: 22px; 
            accent-color: var(--lk-primary); 
        }

        .product-entry, .stylist-entry, .product-sale-entry {
            border: 1px solid var(--lk-outline);
            border-radius: 12px;
            padding: var(--lk-space-md);
            margin-bottom: var(--lk-space-md);
            background: var(--lk-surface);
            position: relative;
            box-shadow: none;
        }

        /* Button styles */
        .btn {
            font-family: inherit;
            font-size: 1rem;
            font-weight: 700;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all var(--lk-transition-normal) ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            letter-spacing: 0;
            text-decoration: none;
            user-select: none;
        }
        .btn-primary { 
            background: var(--lk-primary); 
            color: #111; 
        }
        .btn-primary:hover { 
            background: #FFA31A; 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(255, 153, 0, 0.2);
        }
        .btn-success { 
            background: #111111; 
            color: white; 
        }
        .btn-success:hover { 
            background: #333333; 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(17, 17, 17, 0.2);
        }
        .btn-error {
            background: var(--lk-error); 
            color: white;
            font-size: 0.87rem; 
            padding: 8px 16px;
        }
        .btn-error:hover { 
            background: #DC2626; 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.2);
        }
        .btn-submit {
            width: 100%;
            font-size: 1.2rem;
            padding: 18px var(--lk-space-xl);
            margin-top: var(--lk-space-xl);
            background: var(--lk-primary);
            color: #111;
        }
        .btn-submit:hover {
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 7px 14px rgba(255,153,0,0.12);
        }
        .icon { 
            margin-left: -3px; 
        }
        .space-after-btn {
            display: block;
            height: 18px;
            width: 100%;
        }

        /* Form chooser buttons */
        .form-chooser-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--lk-space-md);
            margin-top: var(--lk-space-lg);
        }

        .form-chooser-buttons .btn {
            margin: 0;
            justify-content: center;
        }

        @media (min-width: 600px) {
            .form-chooser-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--lk-success);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(400px);
            transition: transform var(--lk-transition-slow) ease;
            z-index: var(--lk-z-toast);
            max-width: 300px;
            font-weight: 700;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.error {
            background: var(--lk-error);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Submit ID Display */
        .submit-id-display {
            background: var(--lk-primary);
            color: #111;
            padding: var(--lk-space-sm);
            border-radius: var(--lk-radius-sm);
            margin-bottom: var(--lk-space-md);
            text-align: center;
            font-size: var(--lk-text-caption);
            font-family: monospace;
            display: none;
        }

        /* Autocomplete Styles */
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--lk-surface);
            border: 1px solid var(--lk-outline);
            border-top: none;
            border-radius: 0 0 var(--lk-radius-sm) var(--lk-radius-sm);
            max-height: 200px;
            overflow-y: auto;
            z-index: var(--lk-z-dropdown);
            box-shadow: 0 4px 12px rgba(255,153,0,0.08);
            display: none;
        }

        .autocomplete-suggestion {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--lk-outline-variant);
            font-size: 1rem;
            transition: background-color var(--lk-transition-normal);
        }

        .autocomplete-suggestion:hover {
            background: var(--lk-surface-container);
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        .autocomplete-suggestion .product-type {
            color: var(--lk-on-surface-variant);
            font-size: 0.9rem;
            margin-left: 8px;
        }

        /* Unit Pills Styles */
        .unit-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }

        .unit-pill {
            background: var(--lk-primary);
            color: #111;
            font-size: 0.85rem;
            padding: 4px 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all var(--lk-transition-normal);
            border: none;
            font-family: inherit;
        }

        .unit-pill:hover {
            background: var(--lk-primary-light);
            transform: translateY(-1px);
        }

        .unit-pill.exact-match {
            background: var(--lk-accent);
        }

        .entry-controls {
            margin-top: var(--lk-space-md);
            padding-top: var(--lk-space-md);
            border-top: 1px solid var(--lk-outline-variant);
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: var(--lk-space-sm);
        }

        .section-controls {
            margin-top: var(--lk-space-lg);
            text-align: center;
            padding-top: var(--lk-space-md);
            border-top: 1px solid var(--lk-outline-variant);
        }

        .remove-product-btn,
        .remove-stylist-btn,
        .remove-product-sale-btn {
            position: static !important;
            top: auto !important;
            right: auto !important;
            margin: 0 !important;
            padding: 8px 16px !important;
            font-size: 0.9rem !important;
        }

        /* Responsive design */
        @media (min-width: 600px) {
            .grid-2 { 
                grid-template-columns: repeat(2, 1fr); 
            }
            .container {
                max-width: 490px;
                margin: 32px auto;
                border-radius: var(--lk-radius-lg);
                box-shadow: 0 2px 14px 0 rgba(0,0,0,0.05);
            }
            .space-after-btn { 
                height: 22px; 
            }
        }
        @media (min-width: 900px) {
            .container { 
                max-width: 700px; 
            }
            .label, .input, .select, .checkbox-item { 
                font-size: 1.1rem; 
            }
        }
        @media (min-width: 1200px) {
            .container { 
                max-width: 900px; 
            }
        }

        /* Linktree-style transformation CSS */
        /* 1) Page background and centering */
        body {
            background: linear-gradient(180deg, #f7f7fb 0%, #eef1f7 100%);
        }

        .container {
            max-width: 520px;
            margin: 0 auto;
            padding: 24px 20px 48px;
            background: transparent;
            border: 0;
            box-shadow: none;
            min-height: unset;
        }

        /* 2) Head area like Linktree profile */
        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .title {
            font-size: 1.6rem;
            font-weight: 800;
            color: #111827;
            margin: 8px 0 6px;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 0.95rem;
            color: #6b7280;
            font-weight: 400;
        }

        /* 3) Hide visual chrome: borders, boxes, shadows */
        .section,
        .consent-section,
        .signature-section {
            border: 0 !important;
            background: transparent !important;
            box-shadow: none !important;
            padding: 0 !important;
            margin-bottom: 24px !important;
        }

        .section-title {
            border: 0;
            padding: 0;
            margin: 20px 0 10px;
            font-size: 0.95rem;
            font-weight: 700;
            color: #374151;
        }

        /* 4) Convert all primary interactions into big Linktree-style buttons */
        .btn,
        .btn-submit {
            width: 100%;
            justify-content: center;
            height: 54px;
            border-radius: 14px;
            font-size: 1.05rem;
            font-weight: 700;
            background: #111827;
            color: #fff;
            border: 0;
            box-shadow: 0 6px 16px rgba(17, 24, 39, 0.12);
            transform: translateZ(0);
            transition: transform .15s ease, box-shadow .15s ease, background .15s ease, opacity .15s ease;
        }

        .btn:hover,
        .btn-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(17, 24, 39, 0.16);
            background: #0f172a;
        }

        .btn:active,
        .btn-submit:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(17, 24, 39, 0.12);
        }

        /* Keep success and error as styles, but flatter */
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        .btn-error { background: #ef4444; }
        .btn-error:hover { background: #dc2626; }

        /* 5) Make "form chooser" the top stack buttons like Linktree links */
        .form-chooser-buttons {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-top: 22px;
        }

        .form-chooser-buttons .btn {
            height: 56px;
            border-radius: 16px;
            background: #ffffff;
            color: #111827;
            border: 1px solid #e5e7eb;
            box-shadow: 0 6px 16px rgba(0,0,0,0.06);
        }

        .form-chooser-buttons .btn:hover {
            background: #f9fafb;
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(0,0,0,0.10);
        }

        /* 6) Inputs: minimal, pill-ish, clean */
        .input,
        .textarea,
        .select {
            border: 1px solid #e5e7eb;
            background: #ffffff;
            border-radius: 14px;
            min-height: 48px;
            padding: 12px 14px;
            font-size: 1rem;
            box-shadow: 0 1px 0 rgba(0,0,0,0.02);
        }

        .textarea { min-height: 100px; }

        .input:focus,
        .textarea:focus,
        .select:focus {
            border-color: #111827;
            box-shadow: 0 0 0 3px rgba(17,24,39,0.12);
        }

        .label {
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        /* 7) Make action rows look like stacked links */
        .entry-controls,
        .section-controls {
            border-top: 0;
            padding-top: 0;
            text-align: center;
        }

        /* 8) Turn checkbox grid and radios into cleaner tap targets */
        .checkbox-grid {
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .checkbox-item {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px 12px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: #111827;
        }

        .consent-agreement {
            background: transparent;
            border: 0;
            gap: 12px;
            margin-top: 10px;
        }

        .consent-option {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px 14px;
        }

        .consent-option:hover { background: #f9fafb; }

        /* 9) Signature: keep minimal frame */
        .signature-pad-wrapper {
            border: 2px dashed #e5e7eb;
            background: #fff;
            border-radius: 14px;
        }

        /* 10) Photo upload boxes -> match button cards */
        .photo-upload-box {
            border: 1px dashed #e5e7eb;
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.04);
        }

        .photo-upload-box.has-photo {
            border-color: #10b981;
            background: #ecfdf5;
        }

        /* 11) Autocomplete dropdown clean */
        .autocomplete-suggestions {
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
        }

        .autocomplete-suggestion { font-size: 0.98rem; }

        /* 12) Toast subtle */
        .toast {
            border-radius: 12px;
            box-shadow: 0 8px 22px rgba(0,0,0,0.12);
        }

        /* 13) Hide heavy dividers around entries to keep the list clean */
        .product-entry,
        .stylist-entry,
        .product-sale-entry {
            border: 0;
            background: transparent;
            box-shadow: none;
            padding: 0;
            margin: 0 0 16px;
        }

        /* 14) Make all "Add …" buttons look like Linktree links */
        #addProductBtn,
        #addProductSaleBtn,
        #addStylistBtn {
            background: #ffffff;
            color: #111827;
            border: 1px solid #e5e7eb;
            height: 52px;
            border-radius: 14px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.06);
        }

        #addProductBtn:hover,
        #addProductSaleBtn:hover,
        #addStylistBtn:hover {
            background: #f9fafb;
        }

        /* 15) Submit buttons pinned as big links */
        .btn-submit {
            margin-top: 18px;
            background: #111827 !important;
        }

        /* 16) Small screens */
        @media (min-width: 600px) {
            .container {
                max-width: 520px !important;
                margin: 32px auto;
            }
        }

        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #111827;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 16px;
            font-size: 0.95rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* Button loading states */
        .btn.loading,
        .btn-submit.loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn.loading::after,
        .btn-submit.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Form field loading states */
        .field.loading {
            position: relative;
            pointer-events: none;
        }

        .field.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 12px;
            width: 12px;
            height: 12px;
            margin-top: -6px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #111827;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 480px) {
            .container {
                padding: 16px 12px 32px;
                margin: 0;
            }

            .title {
                font-size: 1.4rem;
            }

            .subtitle {
                font-size: 0.9rem;
            }

            .btn,
            .btn-submit {
                height: 48px;
                font-size: 1rem;
                border-radius: 12px;
            }

            .form-chooser-buttons .btn {
                height: 52px;
                border-radius: 14px;
            }

            .input,
            .textarea,
            .select {
                min-height: 44px;
                padding: 10px 12px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .checkbox-grid {
                gap: 8px;
            }

            .checkbox-item {
                padding: 8px 10px;
                font-size: 0.95rem;
            }

            .consent-option {
                padding: 8px 12px;
                font-size: 0.9rem;
            }

            .signature-pad-wrapper {
                max-width: 100%;
            }

            .photo-upload-box {
                padding: 16px;
            }

            .section-title {
                font-size: 0.9rem;
                margin: 16px 0 8px;
            }

            .label {
                font-size: 0.95rem;
            }

            /* Improve touch targets */
            .btn,
            .btn-submit,
            .checkbox-item,
            .consent-option {
                min-height: 44px;
            }

            /* Better spacing for mobile */
            .section,
            .consent-section,
            .signature-section {
                margin-bottom: 20px !important;
            }

            /* Optimize autocomplete for mobile */
            .autocomplete-suggestions {
                max-height: 150px;
                font-size: 0.95rem;
            }

            .autocomplete-suggestion {
                padding: 10px 12px;
                font-size: 0.95rem;
            }

            /* Improve toast positioning on mobile */
            .toast {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                border-radius: 8px;
            }
        }

        /* Tablet optimizations */
        @media (min-width: 481px) and (max-width: 768px) {
            .container {
                padding: 20px 16px 40px;
            }

            .btn,
            .btn-submit {
                height: 50px;
            }

            .form-chooser-buttons .btn {
                height: 54px;
            }
        }

        /* Landscape mobile optimizations */
        @media (max-width: 768px) and (orientation: landscape) {
            .container {
                padding: 12px 16px 24px;
            }

            .header {
                margin-bottom: 16px;
            }

            .title {
                font-size: 1.3rem;
                margin: 4px 0 4px;
            }

            .subtitle {
                font-size: 0.85rem;
            }
        }

        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .btn,
            .btn-submit,
            .input,
            .textarea,
            .select {
                border-width: 0.5px;
            }
        }

        /* Reduced motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            .btn,
            .btn-submit,
            .loading-spinner,
            .btn.loading::after,
            .btn-submit.loading::after,
            .field.loading::after {
                animation: none;
                transition: none;
            }
        }
    </style>
</head>
<body>
<!-- Form Chooser Section -->
<div id="form-chooser" class="container">
    <div class="header">
        <h1 class="title">Choose Form</h1>
        <p class="subtitle">Select which form you want to fill</p>
        <div class="form-chooser-buttons">
            <button id="show-client-consultation" class="btn btn-primary">Client Consultation</button>
            <button id="show-consumption-form" class="btn btn-success">Consumption Form</button>
        </div>
    </div>
</div>

<div id="client-consultation-section" class="container" style="display: none;">
    <div class="header">
        <h1 class="title">Client Consultation</h1>
        <p class="subtitle">Complete client assessment and service record</p>
        <div id="submitIdDisplay" class="submit-id-display"></div>
    </div>

    <form id="salonForm" autocomplete="off" novalidate>
        <!-- Consent & Acknowledgment Section -->
        <div class="consent-section">
            <div class="consent-title">📋 Consent & Acknowledgment</div>
            
            <div class="consent-content">
                <div class="consent-item">
                    I confirm that the information provided above is accurate and complete to the best of my knowledge.
                </div>
                
                <div class="consent-item">
                    I understand that providing false or incomplete information may affect the quality or safety of the service.
                </div>
                
                <div class="consent-item">
                    I agree to inform my stylist/therapist of any changes to my health or medication during future visits.
                </div>
                
                <div class="consent-item">
                    I consent to Shanuzz Salon using my anonymous health information solely for the purpose of providing safe and effective treatments.
                </div>
                
                <div class="consent-item">
                    I consent to Shanuzz Salon the full rights to use photos/videos of my hair/skin/nails transformation for promotional purposes (e.g., social media, website). My identity will be kept confidential unless otherwise agreed.
                </div>
            </div>
            
            <div class="consent-agreement">
                <label class="consent-option">
                    <input type="radio" name="consent" value="yes" class="consent-radio" required>
                    <span class="consent-label">✅ Yes</span>
                </label>
                <label class="consent-option">
                    <input type="radio" name="consent" value="no" class="consent-radio" required>
                    <span class="consent-label">❌ No</span>
                </label>
            </div>
            <div class="error-message" id="consent-error">Please select your consent preference</div>
        </div>

        <!-- Digital Signature Section -->
        <div class="signature-section">
            <div class="signature-title">✍️ Digital Signature</div>
            
            <div class="signature-container">
                <div class="signature-instructions">
                    Please sign below to confirm your consent and agreement to the terms above
                </div>
                
                <div class="signature-pad-wrapper">
                    <canvas id="signaturePad" class="signature-pad"></canvas>
                </div>
                
                <div class="signature-controls">
                    <button type="button" id="clearSignature" class="signature-btn">🗑️ Clear</button>
                    <button type="button" id="undoSignature" class="signature-btn">↶ Undo</button>
                </div>
                
                <div id="signatureStatus" class="signature-status">
                    ✅ Signature captured successfully
                </div>
                <div class="error-message" id="signature-error">Please provide your digital signature</div>
            </div>
        </div>

        <!-- Client Information Section -->
        <div class="section">
            <div class="section-title">
                <span>👤</span> Client Information
            </div>

            <div class="grid-1">
                <div class="field">
                    <label class="label" for="clientName">Full Name<span class="required">*</span></label>
                    <input type="text" id="clientName" name="clientName" class="input" required>
                    <div class="error-message" id="clientName-error">Please enter the client's full name</div>
                </div>
                <div class="field">
                    <label class="label" for="phone">Phone Number<span class="required">*</span></label>
                    <input type="tel" id="phone" name="phone" class="input" required>
                    <div class="error-message" id="phone-error">Please enter a valid phone number</div>
                </div>
                <div class="field">
                    <label class="label" for="email">Email Address</label>
                    <input type="email" id="email" name="email" class="input">
                    <div class="error-message" id="email-error">Please enter a valid email address</div>
                </div>
                <div class="field">
                    <label class="label" for="visitDate">Visit Date<span class="required">*</span></label>
                    <input type="date" id="visitDate" name="visitDate" class="input" required>
                    <div class="error-message" id="visitDate-error">Please select a valid visit date</div>
                </div>
                <div class="field">
                    <label class="label" for="clientType">Client Type</label>
                    <select id="clientType" name="clientType" class="select">
                        <option value="new">New Client</option>
                        <option value="returning">Returning Client</option>
                        <option value="walk-in">Walk-in</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Consultation Section -->
        <div class="section">
            <div class="section-title">
                <span>💬</span> Client Consultation
            </div>

            <div class="field">
                <label class="label">
                    Desired Services<span class="required">*</span>
                </label>
                <div class="checkbox-grid" role="group" aria-labelledby="services-label">
                    <label class="checkbox-item">
                        <input type="checkbox" class="checkbox" name="services" value="haircut">
                        Haircut
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" class="checkbox" name="services" value="coloring">
                        Hair Coloring
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" class="checkbox" name="services" value="styling">
                        Hair Styling
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" class="checkbox" name="services" value="treatment">
                        Hair Treatment
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" class="checkbox" name="services" value="facial">
                        Facial
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" class="checkbox" name="services" value="manicure">
                        Manicure/Pedicure
                    </label>
                </div>
                <div class="error-message" id="services-error">Please select at least one service</div>
            </div>

            <div class="grid-1">
                <div class="field">
                    <label class="label" for="hairType">Hair Type</label>
                    <select id="hairType" name="hairType" class="select">
                        <option value="">Select Hair Type</option>
                        <option value="straight">Straight</option>
                        <option value="wavy">Wavy</option>
                        <option value="curly">Curly</option>
                        <option value="coily">Coily</option>
                    </select>
                </div>
                <div class="field">
                    <label class="label" for="hairTexture">Hair Texture</label>
                    <select id="hairTexture" name="hairTexture" class="select">
                        <option value="">Select Texture</option>
                        <option value="fine">Fine</option>
                        <option value="medium">Medium</option>
                        <option value="thick">Thick</option>
                    </select>
                </div>
                <div class="field">
                    <label class="label" for="scalpCondition">Scalp Condition</label>
                    <select id="scalpCondition" name="scalpCondition" class="select">
                        <option value="">Select Condition</option>
                        <option value="normal">Normal</option>
                        <option value="oily">Oily</option>
                        <option value="dry">Dry</option>
                        <option value="sensitive">Sensitive</option>
                        <option value="dandruff">Dandruff</option>
                    </select>
                </div>
                <div class="field">
                    <label class="label" for="previousTreatments">Previous Chemical Treatments</label>
                    <input type="text" id="previousTreatments" name="previousTreatments" class="input" placeholder="e.g., Last color, relaxer, perm">
                </div>
                <div class="field">
                    <label class="label" for="allergies">Allergies/Sensitivities</label>
                    <textarea id="allergies" name="allergies" class="textarea" placeholder="Please list any known allergies or sensitivities"></textarea>
                </div>
                <div class="field">
                    <label class="label" for="clientExpectations">Client Expectations & Notes</label>
                    <textarea id="clientExpectations" name="clientExpectations" class="textarea" placeholder="Describe what the client wants to achieve, any concerns, or special requests"></textarea>
                </div>
            </div>
        </div>
        <!-- Place the Before Photo section here -->
        <div class="photo-section">
            <h3 style="margin-bottom: var(--lk-space-md); font-size: 1.1rem; color: var(--lk-on-surface);">📸 Before Photo</h3>
            <div class="photo-upload-box" id="beforePhotoBox">
                <input type="file" id="beforePhoto" name="beforePhoto" class="photo-input" accept="image/*" capture="environment">
                <div class="photo-upload-icon">📷</div>
                <div class="photo-upload-text">📷 Take Before Photo</div>
                <img id="beforePhotoPreview" class="photo-preview" alt="Before photo preview">
                <div class="photo-controls" style="display: none;">
                    <button type="button" class="photo-btn" onclick="SalonForm.retakePhoto('before')">🔄 Retake</button>
                    <button type="button" class="photo-btn remove" onclick="SalonForm.removePhoto('before')">🗑️ Remove</button>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary btn-submit">
            <span class="icon">💾</span> Save Client Record
        </button>
    </form>
</div>

<div id="consumption-form-section" class="container" style="display: none;">
    <div class="header">
        <h1 class="title">Consumption Form</h1>
        <p class="subtitle">Complete Consumption record</p>
        <div id="submitIdDisplay2" class="submit-id-display"></div>
    </div>
    <form id="consumptionForm" autocomplete="off" novalidate>
        <div class="grid-1">
            <div class="field">
                <label class="label" for="consultationId">Consultation ID<span class="required">*</span></label>
                <input type="text" id="consultationId" name="consultationId" class="input" required placeholder="Enter Consultation ID">
                <div class="autocomplete-suggestions"></div>
                <div class="error-message" id="consultationId-error">Please enter the Consultation ID</div>
            </div>
        </div>
        <!-- After Photo Section -->
        <div class="photo-section" style="margin-top: var(--lk-space-xl); margin-bottom: var(--lk-space-xl);">
            <h3 style="margin-bottom: var(--lk-space-md); font-size: 1.1rem; color: var(--lk-on-surface);">📸 After Photo</h3>
            <div class="photo-upload-box" id="afterPhotoBox">
                <input type="file" id="afterPhoto" name="afterPhoto" class="photo-input" accept="image/*" capture="environment">
                <div class="photo-upload-icon">📷</div>
                <div class="photo-upload-text">📷 Take After Photo</div>
                <img id="afterPhotoPreview" class="photo-preview" alt="After photo preview">
                <div class="photo-controls" style="display: none;">
                    <button type="button" class="photo-btn" onclick="SalonForm.retakePhoto('after')">🔄 Retake</button>
                    <button type="button" class="photo-btn remove" onclick="SalonForm.removePhoto('after')">🗑️ Remove</button>
                </div>
            </div>
        </div>
        <!-- Product Consumption Section -->
        <div class="section">
            <div class="section-title">
                <span>🧴</span> Product Consumption & Inventory
            </div>
            <div id="productContainer">
                <div class="product-entry">
                    <div class="grid-1">
                        <div class="field">
                            <label class="label">Product Name</label>
                            <input type="text" name="productName[]" class="input product-name-input" placeholder="Start typing product name..." autocomplete="off">
                            <div class="autocomplete-suggestions"></div>
                        </div>
                        <div class="field">
                            <label class="label">Product Type</label>
                            <input type="text" name="productType[]" class="input product-type-input" readonly placeholder="Auto-filled when product selected">
                        </div>
                        <div class="quantity-unit-grid">
                            <div class="field">
                                <label class="label">Quantity Used</label>
                                <input type="text" name="quantityUsed[]" class="input" placeholder="e.g., 50, 100, 2">
                            </div>
                            <div class="field">
                                <label class="label">Unit</label>
                                <input type="text" name="unit[]" class="input unit-input" placeholder="Auto-filled">
                                <div class="unit-pills"></div>
                            </div>
                        </div>
                    </div>
                    <div class="entry-controls">
                        <button type="button" class="btn btn-error remove-product-btn" aria-label="Remove product entry">Remove</button>
                    </div>
                </div>
            </div>
            <div class="section-controls">
                <button type="button" class="btn btn-success" id="addProductBtn">
                    <span class="icon">+</span> Add Product Used
                </button>
            </div>
        </div>
        <!-- Product Sale & Inventory Section -->
        <div class="section">
            <div class="section-title">
                <span>💰</span> Product Sale & Inventory
            </div>
            <div id="productSaleContainer">
                <div class="product-sale-entry">
                    <div class="grid-1">
                        <div class="field">
                            <label class="label">Product Name</label>
                            <input type="text" name="saleProductName[]" class="input sale-product-name-input" placeholder="Start typing product name..." autocomplete="off">
                            <div class="autocomplete-suggestions"></div>
                        </div>
                        <div class="field">
                            <label class="label">Stylist/Technician</label>
                            <input type="text" name="saleStylistName[]" class="input sale-stylist-name-input" placeholder="Start typing stylist name..." autocomplete="off">
                            <div class="autocomplete-suggestions"></div>
                        </div>
                        <div class="field">
                            <label class="label">Price (₹)</label>
                            <input type="number" name="salePrice[]" class="input sale-price-input" step="0.01" placeholder="0.00" min="0">
                        </div>
                    </div>
                    <div class="entry-controls">
                        <button type="button" class="btn btn-error remove-product-sale-btn" aria-label="Remove product sale entry">Remove</button>
                    </div>
                </div>
            </div>
            <div class="grid-1">
                <div class="field">
                    <label class="label">Total (₹)</label>
                    <input type="number" name="saleTotal[]" class="input sale-total-input" step="0.01" placeholder="Auto-calculated" readonly>
                </div>
            </div>
            <div class="section-controls">
                <button type="button" class="btn btn-success" id="addProductSaleBtn">
                    <span class="icon">+</span> Add Product Sale
                </button>
            </div>
        </div>
        <!-- Service Details Section -->
        <div class="section">
            <div class="section-title">
                <span>✨</span> Service Details & Results
            </div>
            <div id="stylistContainer">
                <div class="stylist-entry">
                    <div class="grid-1">
                        <div class="field">
                            <label class="label" for="stylistName0">
                                Stylist/Technician Name<span class="required">*</span>
                            </label>
                            <input type="text" id="stylistName0" name="stylistName[]" class="input stylist-name-input" required placeholder="Start typing stylist name..." autocomplete="off">
                            <div class="autocomplete-suggestions"></div>
                        </div>
                        <div class="field">
                            <label class="label" for="incentiveSplit0">Incentive Split (₹)</label>
                            <input type="number" id="incentiveSplit0" name="incentiveSplit[]" class="input stylist-incentive-input" step="0.01" placeholder="Incentive amount">
                        </div>
                    </div>
                    <div class="entry-controls">
                        <button type="button" class="btn btn-error remove-stylist-btn" aria-label="Remove stylist entry">Remove</button>
                    </div>
                </div>
            </div>
            <div class="grid-1">
                <div class="field">
                    <label class="label" for="totalCost">Total Amount (₹)</label>
                    <input type="number" id="totalCost" name="totalCost" class="input" readonly placeholder="Auto-calculated total" aria-live="polite">
                </div>
            </div>
            <div class="section-controls">
                <button type="button" class="btn btn-success" id="addStylistBtn">
                    <span class="icon">+</span> Add Stylist / Incentive
                </button>
            </div>
        </div>
        <!-- Service Notes Section -->
        <div class="section">
            <div class="section-title">
                <span>📝</span> Service Notes & Techniques
            </div>
            <div class="field">
                <label class="label" for="serviceNotes">Service Notes & Techniques Used</label>
                <textarea id="serviceNotes" name="serviceNotes" class="textarea" placeholder="Document the process, techniques, formulations, timing, and important details"></textarea>
            </div>
            <div class="field">
                <label class="label" for="clientSatisfaction">Client Satisfaction</label>
                <select id="clientSatisfaction" name="clientSatisfaction" class="select">
                    <option value="">Rate Satisfaction</option>
                    <option value="5">⭐⭐⭐⭐⭐ Excellent</option>
                    <option value="4">⭐⭐⭐⭐ Very Good</option>
                    <option value="3">⭐⭐⭐ Good</option>
                    <option value="2">⭐⭐ Fair</option>
                    <option value="1">⭐ Needs Improvement</option>
                </select>
            </div>
            <div class="field">
                <label class="label" for="followUp">Follow-up Recommendations</label>
                <textarea id="followUp" name="followUp" class="textarea" placeholder="Next appointment suggestions, home care recommendations"></textarea>
            </div>
        </div>
        <button type="submit" class="btn btn-primary btn-submit">
            <span class="icon">💾</span> Save Consumption Record
        </button>
    </form>
</div>

<div id="toast" class="toast" role="alert" aria-live="assertive"></div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div style="text-align: center;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
</div>

<template id="productTemplate">
    <div class="product-entry">
        <div class="grid-1">
            <div class="field">
                <label class="label">Product Name</label>
                <input type="text" name="productName[]" class="input product-name-input" placeholder="Start typing product name..." autocomplete="off">
                <div class="autocomplete-suggestions"></div>
            </div>
            <div class="field">
                <label class="label">Product Type</label>
                <input type="text" name="productType[]" class="input product-type-input" readonly placeholder="Auto-filled when product selected">
            </div>
            <div class="quantity-unit-grid">
                <div class="field">
                    <label class="label">Quantity Used</label>
                    <input type="text" name="quantityUsed[]" class="input" placeholder="e.g., 50, 100, 2">
                </div>
                <div class="field">
                    <label class="label">Unit</label>
                    <input type="text" name="unit[]" class="input unit-input" placeholder="Auto-filled">
                    <div class="unit-pills"></div>
                </div>
            </div>
        </div>
        <div class="entry-controls">
            <button type="button" class="btn btn-error remove-product-btn" aria-label="Remove product entry">Remove</button>
        </div>
    </div>
</template>

<template id="stylistTemplate">
    <div class="stylist-entry">
        <div class="grid-1">
            <div class="field">
                <label class="label">
                    Stylist/Technician Name<span class="required">*</span>
                </label>
                <input type="text" name="stylistName[]" class="input stylist-name-input" required placeholder="Start typing stylist name..." autocomplete="off">
                <div class="autocomplete-suggestions"></div>
            </div>
            <div class="field">
                <label class="label">Incentive Split (₹)</label>
                <input type="number" name="incentiveSplit[]" class="input stylist-incentive-input" step="0.01" placeholder="Incentive amount">
            </div>
        </div>
        <div class="entry-controls">
            <button type="button" class="btn btn-error remove-stylist-btn" aria-label="Remove stylist entry">Remove</button>
        </div>
    </div>
</template>

<template id="productSaleTemplate">
    <div class="product-sale-entry">
        <div class="grid-1">
            <div class="field">
                <label class="label">Product Name</label>
                <input type="text" name="saleProductName[]" class="input sale-product-name-input" placeholder="Start typing product name..." autocomplete="off">
                <div class="autocomplete-suggestions"></div>
            </div>
            <div class="field">
                <label class="label">Stylist/Technician</label>
                <input type="text" name="saleStylistName[]" class="input sale-stylist-name-input" placeholder="Start typing stylist name..." autocomplete="off">
                <div class="autocomplete-suggestions"></div>
            </div>
            <div class="field">
                <label class="label">Price (₹)</label>
                <input type="number" name="salePrice[]" class="input sale-price-input" step="0.01" placeholder="0.00" min="0">
            </div>
        </div>
        <div class="entry-controls">
            <button type="button" class="btn btn-error remove-product-sale-btn" aria-label="Remove product sale entry">Remove</button>
        </div>
    </div>
</template>

<script>
(function() {
    'use strict';
    
    // Configuration constants
    const CONFIG = {
        CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQwMeJAvIhiingIL1otFVM08kZedwZKC-u3uXplgXJmwcBlcWRFGuMQbcH-gSLu7Iqr-GFSyLKTxJdO/pub?gid=970040881&single=true&output=csv",
        APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbynE1KRwABodBVmrzC3jep5LweAP0B53pUPW89PgL_EGrx8IKH5ikMj2EN3QWY6a2ZThQ/exec',
        MAX_FILE_SIZE: 5 * 1024 * 1024, // 5MB
        MAX_SIGNATURE_STATES: 10,
        DEBOUNCE_DELAY: 300,
        TOAST_DURATION: 6000,
        RETRY_ATTEMPTS: 3,
        RETRY_DELAY: 1000,
        CACHE_DURATION: 5 * 60 * 1000 // 5 minutes
    };
    
    // State management
    const state = {
        products: [],
        stylists: [],
        consultationIds: [],
        saleProducts: [],
        salePrices: {},
        signaturePad: null,
        signatureCanvas: null,
        isDrawing: false,
        lastX: 0,
        lastY: 0,
        lastDrawTime: null,
        signatureData: [],
        statusUpdateTimer: null,
        beforePhotoData: null,
        afterPhotoData: null,
        isFormSubmitting: false,
        debounceTimers: new Map(),
        // Performance and loading state management
        isLoading: false,
        loadingText: '',
        dataCache: new Map(),
        lastDataFetch: 0,
        retryCount: 0,
        isOnline: navigator.onLine,
        // Performance optimizations
        observer: null,
        intersectionObserver: null,
        resizeObserver: null
    };
    
    // Utility functions
    const utils = {
        /**
         * Generate unique submit ID in format AA01AA1111
         * @returns {string} Unique submit ID
         */
        generateSubmitId() {
            // Generate 2 random uppercase letters
            const letters1 = String.fromCharCode(65 + Math.floor(Math.random() * 26)) + 
                           String.fromCharCode(65 + Math.floor(Math.random() * 26));
            
            // Generate 2 random digits
            const digits1 = Math.floor(Math.random() * 100).toString().padStart(2, '0');
            
            // Generate 2 more random uppercase letters
            const letters2 = String.fromCharCode(65 + Math.floor(Math.random() * 26)) + 
                           String.fromCharCode(65 + Math.floor(Math.random() * 26));
            
            // Generate 4 random digits
            const digits2 = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            
            return `${letters1}${digits1}${letters2}${digits2}`;
        },
        
        /**
         * Sanitize HTML content to prevent XSS
         * @param {string} text - Text to sanitize
         * @returns {string} Sanitized text
         */
        sanitizeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },
        
        /**
         * Debounce function calls
         * @param {Function} func - Function to debounce
         * @param {number} delay - Delay in milliseconds
         * @param {string} key - Unique key for the debounced function
         * @returns {Function} Debounced function
         */
        debounce(func, delay, key) {
            return (...args) => {
                if (state.debounceTimers.has(key)) {
                    clearTimeout(state.debounceTimers.get(key));
                }
                const timer = setTimeout(() => func.apply(this, args), delay);
                state.debounceTimers.set(key, timer);
            };
        },
        
        /**
         * Validate email format
         * @param {string} email - Email to validate
         * @returns {boolean} Is valid email
         */
        isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        },
        
        /**
         * Validate phone number format
         * @param {string} phone - Phone number to validate
         * @returns {boolean} Is valid phone number
         */
        isValidPhone(phone) {
            return /^[\+]?[1-9][\d]{0,15}$/.test(phone.replace(/\s/g, ''));
        },
        
        /**
         * Check if running in development
         * @returns {boolean} Is development environment
         */
        isDevelopment() {
            return window.location.hostname === 'localhost' || 
                   window.location.hostname === '127.0.0.1' ||
                   window.location.protocol === 'file:';
        },

        /**
         * Show loading overlay
         * @param {string} text - Loading text to display
         */
        showLoading(text = 'Loading...') {
            state.isLoading = true;
            state.loadingText = text;
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            if (overlay && loadingText) {
                loadingText.textContent = text;
                overlay.classList.add('show');
            }
        },

        /**
         * Hide loading overlay
         */
        hideLoading() {
            state.isLoading = false;
            state.loadingText = '';
            const overlay = document.getElementById('loadingOverlay');
            
            if (overlay) {
                overlay.classList.remove('show');
            }
        },

        /**
         * Show button loading state
         * @param {HTMLButtonElement} button - Button to show loading for
         * @param {string} loadingText - Text to show while loading
         */
        showButtonLoading(button, loadingText = 'Loading...') {
            if (button) {
                button.classList.add('loading');
                button.setAttribute('data-original-text', button.innerHTML);
                button.innerHTML = loadingText;
                button.disabled = true;
            }
        },

        /**
         * Hide button loading state
         * @param {HTMLButtonElement} button - Button to hide loading for
         */
        hideButtonLoading(button) {
            if (button) {
                button.classList.remove('loading');
                const originalText = button.getAttribute('data-original-text');
                if (originalText) {
                    button.innerHTML = originalText;
                    button.removeAttribute('data-original-text');
                }
                button.disabled = false;
            }
        },

        /**
         * Check if data is cached and not expired
         * @param {string} key - Cache key
         * @returns {boolean} Is data cached and valid
         */
        isDataCached(key) {
            const cached = state.dataCache.get(key);
            if (!cached) return false;
            
            const now = Date.now();
            return (now - cached.timestamp) < CONFIG.CACHE_DURATION;
        },

        /**
         * Get cached data
         * @param {string} key - Cache key
         * @returns {*} Cached data or null
         */
        getCachedData(key) {
            const cached = state.dataCache.get(key);
            return cached ? cached.data : null;
        },

        /**
         * Set cached data
         * @param {string} key - Cache key
         * @param {*} data - Data to cache
         */
        setCachedData(key, data) {
            state.dataCache.set(key, {
                data: data,
                timestamp: Date.now()
            });
        },

        /**
         * Retry function with exponential backoff
         * @param {Function} fn - Function to retry
         * @param {number} maxAttempts - Maximum retry attempts
         * @returns {Promise} Promise that resolves with function result
         */
        async retryWithBackoff(fn, maxAttempts = CONFIG.RETRY_ATTEMPTS) {
            let lastError;
            
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                try {
                    return await fn();
                } catch (error) {
                    lastError = error;
                    
                    if (attempt === maxAttempts) {
                        throw error;
                    }
                    
                    // Exponential backoff
                    const delay = CONFIG.RETRY_DELAY * Math.pow(2, attempt - 1);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            throw lastError;
        }
    };
    
    // Main SalonForm object with improved modularity
    const SalonForm = {
        /**
         * Initialize the form application with performance optimizations
         */
        init() {
            // Set up performance optimizations
            this.setupPerformanceOptimizations();
            
            // Initialize core functionality
            this.setInitialDate();
            this.bindEvents();
            this.updateTotalCost();
            this.loadProducts();
            this.initSignaturePad();
            this.initPhotoHandlers();
            this.setupEventDelegation();
            
            // Set up mobile-specific optimizations
            this.setupMobileOptimizations();
            
            // Monitor online/offline status
            this.setupConnectivityMonitoring();
        },

        /**
         * Set up performance optimizations
         */
        setupPerformanceOptimizations() {
            // Use Intersection Observer for lazy loading if needed
            if ('IntersectionObserver' in window) {
                state.intersectionObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            // Optimize elements when they come into view
                            entry.target.classList.add('optimized');
                        }
                    });
                }, { threshold: 0.1 });
            }
            
            // Use Resize Observer for responsive optimizations
            if ('ResizeObserver' in window) {
                state.resizeObserver = new ResizeObserver((entries) => {
                    entries.forEach(entry => {
                        // Handle responsive adjustments
                        this.handleResize(entry);
                    });
                });
            }
            
            // Optimize scroll performance
            let ticking = false;
            const handleScroll = () => {
                if (!ticking) {
                    requestAnimationFrame(() => {
                        // Handle scroll optimizations
                        ticking = false;
                    });
                    ticking = true;
                }
            };
            
            window.addEventListener('scroll', handleScroll, { passive: true });
        },

        /**
         * Set up mobile-specific optimizations
         */
        setupMobileOptimizations() {
            // Prevent zoom on input focus (iOS)
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    if (window.innerWidth <= 768) {
                        // Add viewport meta tag if not present
                        let viewport = document.querySelector('meta[name="viewport"]');
                        if (!viewport) {
                            viewport = document.createElement('meta');
                            viewport.name = 'viewport';
                            document.head.appendChild(viewport);
                        }
                        viewport.content = 'width=device-width, initial-scale=1, maximum-scale=1';
                    }
                });
            });
            
            // Optimize touch targets
            const touchTargets = document.querySelectorAll('.btn, .checkbox-item, .consent-option');
            touchTargets.forEach(target => {
                target.style.minHeight = '44px';
                target.style.minWidth = '44px';
            });
            
            // Handle orientation changes
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    this.handleOrientationChange();
                }, 100);
            });
        },

        /**
         * Set up connectivity monitoring
         */
        setupConnectivityMonitoring() {
            window.addEventListener('online', () => {
                state.isOnline = true;
                this.showToast('Connection restored', 'success');
            });
            
            window.addEventListener('offline', () => {
                state.isOnline = false;
                this.showToast('Connection lost. Some features may be limited.', 'error');
            });
        },

        /**
         * Handle resize events
         */
        handleResize(entry) {
            const { width, height } = entry.contentRect;
            
            // Adjust layout based on screen size
            if (width < 480) {
                document.body.classList.add('mobile-view');
            } else {
                document.body.classList.remove('mobile-view');
            }
        },

        /**
         * Handle orientation change
         */
        handleOrientationChange() {
            // Reinitialize signature pad after orientation change
            if (document.getElementById('signaturePad')) {
                setTimeout(() => {
                    this.initSignaturePad();
                }, 200);
            }
            
            // Adjust container height
            const container = document.querySelector('.container');
            if (container) {
                container.style.minHeight = window.innerHeight + 'px';
            }
        },

        /**
         * Set up event delegation for dynamic elements
         */
        setupEventDelegation() {
            document.addEventListener('click', (e) => {
                // Handle remove product button
                if (e.target.closest('.remove-product-btn')) {
                    this.handleRemoveProduct(e);
                }
                
                // Handle remove stylist button
                if (e.target.closest('.remove-stylist-btn')) {
                    this.handleRemoveStylist(e);
                }
                
                // Handle remove product sale button
                if (e.target.closest('.remove-product-sale-btn')) {
                    this.handleRemoveProductSale(e);
                }
            });
        },

        /**
         * Handle remove product entry
         * @param {Event} e - Click event
         */
        handleRemoveProduct(e) {
            const entry = e.target.closest('.product-entry');
            const allEntries = document.querySelectorAll('.product-entry');
            
            if (allEntries.length > 1) {
                entry.remove();
                this.showToast('Product removed', 'success');
            } else {
                this.showToast('At least one product is required', 'error');
            }
        },

        /**
         * Handle remove stylist entry
         * @param {Event} e - Click event
         */
        handleRemoveStylist(e) {
            const entry = e.target.closest('.stylist-entry');
            const allEntries = document.querySelectorAll('.stylist-entry');
            
            if (allEntries.length > 1) {
                entry.remove();
                this.updateTotalCost();
                this.showToast('Stylist removed', 'success');
            } else {
                this.showToast('At least one stylist is required', 'error');
            }
        },

        /**
         * Handle remove product sale entry
         * @param {Event} e - Click event
         */
        handleRemoveProductSale(e) {
            const entry = e.target.closest('.product-sale-entry');
            const allEntries = document.querySelectorAll('.product-sale-entry');
            
            if (allEntries.length > 1) {
                entry.remove();
                this.updateSaleTotal();
                this.showToast('Product sale removed', 'success');
            } else {
                this.showToast('At least one product sale is required', 'error');
            }
        },

        /**
         * Initialize photo upload handlers
         */
        initPhotoHandlers() {
            const beforeInput = document.getElementById('beforePhoto');
            const afterInput = document.getElementById('afterPhoto');
            
            if (beforeInput) {
                beforeInput.addEventListener('change', (e) => this.handlePhotoSelection(e, 'before'));
            }
            if (afterInput) {
                afterInput.addEventListener('change', (e) => this.handlePhotoSelection(e, 'after'));
            }
        },

        /**
         * Handle photo file selection with validation
         * @param {Event} event - File input change event
         * @param {string} type - Photo type ('before' or 'after')
         */
        handlePhotoSelection(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file size
            if (file.size > CONFIG.MAX_FILE_SIZE) {
                this.showToast(`Photo file size must be less than ${CONFIG.MAX_FILE_SIZE / (1024 * 1024)}MB`, 'error');
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                this.showToast('Please select a valid image file', 'error');
                return;
            }
            
            // Read and process file
            const reader = new FileReader();
            reader.onload = (e) => {
                const photoData = e.target.result;
                
                // Store photo data in state
                if (type === 'before') {
                    state.beforePhotoData = photoData;
                } else if (type === 'after') {
                    state.afterPhotoData = photoData;
                }
                
                this.displayPhotoPreview(type, photoData, !state.isFormSubmitting);
            };
            
            reader.onerror = () => {
                this.showToast('Error reading photo file', 'error');
            };
            
            reader.readAsDataURL(file);
        },

        displayPhotoPreview(type, photoData, showToast = true) {
            const preview = document.getElementById(`${type}PhotoPreview`);
            const box = document.getElementById(`${type}PhotoBox`);
            const controls = box.querySelector('.photo-controls');
            const uploadText = box.querySelector('.photo-upload-text');
            const uploadIcon = box.querySelector('.photo-upload-icon');
            
            preview.src = photoData;
            preview.style.display = 'block';
            controls.style.display = 'flex';
            uploadText.style.display = 'none';
            uploadIcon.style.display = 'none';
            box.classList.add('has-photo');
            
            if (showToast) {
                this.showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} photo uploaded successfully!`, 'success');
            }
        },

        retakePhoto(type) {
            const input = document.getElementById(`${type}Photo`);
            input.click();
        },

        removePhoto(type) {
            const preview = document.getElementById(`${type}PhotoPreview`);
            const box = document.getElementById(`${type}PhotoBox`);
            const controls = box.querySelector('.photo-controls');
            const uploadText = box.querySelector('.photo-upload-text');
            const uploadIcon = box.querySelector('.photo-upload-icon');
            const input = document.getElementById(`${type}Photo`);
            
            preview.style.display = 'none';
            preview.src = '';
            controls.style.display = 'none';
            uploadText.style.display = 'block';
            uploadIcon.style.display = 'block';
            box.classList.remove('has-photo');
            input.value = '';
            
            if (type === 'before') {
                state.beforePhotoData = null;
            } else if (type === 'after') {
                state.afterPhotoData = null;
            }
            this.showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} photo removed`, 'success');
        },

        removePhotoSilently(type) {
            const preview = document.getElementById(`${type}PhotoPreview`);
            const box = document.getElementById(`${type}PhotoBox`);
            const controls = box.querySelector('.photo-controls');
            const uploadText = box.querySelector('.photo-upload-text');
            const uploadIcon = box.querySelector('.photo-upload-icon');
            const input = document.getElementById(`${type}Photo`);
            
            preview.style.display = 'none';
            preview.src = '';
            controls.style.display = 'none';
            uploadText.style.display = 'block';
            uploadIcon.style.display = 'block';
            box.classList.remove('has-photo');
            input.value = '';
            
            if (type === 'before') {
                state.beforePhotoData = null;
            } else if (type === 'after') {
                state.afterPhotoData = null;
            }
            // No toast message for silent removal
        },

        /**
         * Initialize signature pad with canvas and event handlers
         */
        initSignaturePad() {
            // Clean up any existing signature pad
            this.cleanupSignaturePad();
            
            const canvas = document.getElementById('signaturePad');
            if (!canvas) {
                console.error('Signature pad canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Could not get 2D context for signature pad');
                return;
            }
            
            // Force canvas to have proper dimensions
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            // Set canvas dimensions based on container or use default
            const width = Math.max(containerRect.width, 400);
            const height = 150;
            const dpr = window.devicePixelRatio || 1;
            
            // Set canvas dimensions
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            
            // Scale context for high DPI displays
            ctx.scale(dpr, dpr);
            
            // Set up drawing context with optimized settings
            ctx.strokeStyle = '#0F172A';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Enable image smoothing for better quality
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            // Store canvas reference for later use
            state.signatureCanvas = canvas;
            state.signaturePad = ctx;
            
            // Initialize drawing state
            state.isDrawing = false;
            state.lastX = 0;
            state.lastY = 0;
            state.signatureData = [];
            
            // Remove test event listener that was causing issues
            // canvas.addEventListener('click', (e) => { ... });
            
            // Drawing event listeners with optimized performance
            canvas.addEventListener('mousedown', this.startDrawing.bind(this), { passive: false });
            canvas.addEventListener('mousemove', this.draw.bind(this), { passive: false });
            canvas.addEventListener('mouseup', this.stopDrawing.bind(this), { passive: false });
            canvas.addEventListener('mouseout', this.stopDrawing.bind(this), { passive: false });
            
            // Touch events for mobile with better handling
            canvas.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: false });
            canvas.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
            canvas.addEventListener('touchend', this.stopDrawing.bind(this), { passive: false });
            canvas.addEventListener('touchcancel', this.stopDrawing.bind(this), { passive: false });
            
            // Control buttons
            const clearBtn = document.getElementById('clearSignature');
            const undoBtn = document.getElementById('undoSignature');
            
            if (clearBtn) {
                clearBtn.addEventListener('click', this.clearSignature.bind(this));
            }
            if (undoBtn) {
                undoBtn.addEventListener('click', this.undoSignature.bind(this));
            }
            
            console.log('Signature pad initialized successfully');
            console.log('Canvas dimensions:', canvas.width, 'x', canvas.height);
            console.log('Canvas style dimensions:', canvas.style.width, 'x', canvas.style.height);
        },

        startDrawing(e) {
            e.preventDefault();
            state.isDrawing = true;
            
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            state.lastX = x;
            state.lastY = y;
            
            state.signaturePad.beginPath();
            state.signaturePad.moveTo(x, y);
            
            // Save state for undo (only when starting)
            this.saveSignatureState();
        },

        draw(e) {
            if (!state.isDrawing) return;
            
            e.preventDefault();
            
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Throttle drawing for better performance
            const now = Date.now();
            if (state.lastDrawTime && now - state.lastDrawTime < 16) { // ~60fps
                return;
            }
            state.lastDrawTime = now;
            
            // Use quadratic curve for smoother lines
            const midX = (state.lastX + x) / 2;
            const midY = (state.lastY + y) / 2;
            
            state.signaturePad.quadraticCurveTo(state.lastX, state.lastY, midX, midY);
            state.signaturePad.stroke();
            
            state.lastX = x;
            state.lastY = y;
            
            // Update status less frequently to improve performance
            if (!state.statusUpdateTimer) {
                state.statusUpdateTimer = setTimeout(() => {
                    this.updateSignatureStatus();
                    state.statusUpdateTimer = null;
                }, 100);
            }
        },

        stopDrawing() {
            if (state.isDrawing) {
                state.signaturePad.stroke();
                state.isDrawing = false;
                state.lastX = 0;
                state.lastY = 0;
                
                // Clear status update timer
                if (state.statusUpdateTimer) {
                    clearTimeout(state.statusUpdateTimer);
                    state.statusUpdateTimer = null;
                }
                
                this.updateSignatureStatus();
            }
        },

        handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = e.target.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            state.isDrawing = true;
            state.lastX = x;
            state.lastY = y;
            
            state.signaturePad.beginPath();
            state.signaturePad.moveTo(x, y);
            
            // Save state for undo
            this.saveSignatureState();
        },

        handleTouchMove(e) {
            if (!state.isDrawing) return;
            
            e.preventDefault();
            const touch = e.touches[0];
            const rect = e.target.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            // Throttle drawing for better performance
            const now = Date.now();
            if (state.lastDrawTime && now - state.lastDrawTime < 16) { // ~60fps
                return;
            }
            state.lastDrawTime = now;
            
            // Use quadratic curve for smoother lines
            const midX = (state.lastX + x) / 2;
            const midY = (state.lastY + y) / 2;
            
            state.signaturePad.quadraticCurveTo(state.lastX, state.lastY, midX, midY);
            state.signaturePad.stroke();
            
            state.lastX = x;
            state.lastY = y;
            
            // Update status less frequently
            if (!state.statusUpdateTimer) {
                state.statusUpdateTimer = setTimeout(() => {
                    this.updateSignatureStatus();
                    state.statusUpdateTimer = null;
                }, 100);
            }
        },

        saveSignatureState() {
            if (!state.signatureCanvas) {
                console.error('Signature canvas not available');
                return;
            }
            
            // Only save state if there's actually something drawn
            if (!this.isSignatureEmpty(state.signatureCanvas)) {
                state.signatureData.push(state.signatureCanvas.toDataURL());
                
                // Keep only last 10 states for performance
                if (state.signatureData.length > CONFIG.MAX_SIGNATURE_STATES) {
                    state.signatureData.shift();
                }
            }
        },

        clearSignature() {
            if (!state.signatureCanvas || !state.signaturePad) {
                console.error('Signature pad not initialized');
                return;
            }
            
            const canvas = state.signatureCanvas;
            const ctx = state.signaturePad;
            
            // Clear the canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Reset drawing state
            state.isDrawing = false;
            state.lastX = 0;
            state.lastY = 0;
            state.signatureData = [];
            
            // Clear status update timer
            if (state.statusUpdateTimer) {
                clearTimeout(state.statusUpdateTimer);
                state.statusUpdateTimer = null;
            }
            
            this.updateSignatureStatus();
            this.clearSignatureError();
        },

        undoSignature() {
            if (state.signatureData.length > 1) {
                state.signatureData.pop(); // Remove current state
                const previousState = state.signatureData[state.signatureData.length - 1];
                
                const canvas = state.signatureCanvas;
                const img = new Image();
                img.onload = () => {
                    state.signaturePad.clearRect(0, 0, canvas.width, canvas.height);
                    state.signaturePad.drawImage(img, 0, 0);
                    this.updateSignatureStatus();
                };
                img.src = previousState;
            } else {
                this.clearSignature();
            }
        },

        updateSignatureStatus() {
            const canvas = state.signatureCanvas;
            const isEmpty = this.isSignatureEmpty(canvas);
            const statusElement = document.getElementById('signatureStatus');
            
            if (!statusElement) return;
            
            if (isEmpty) {
                statusElement.className = 'signature-status empty';
                statusElement.textContent = '⚠️ Please provide your signature';
            } else {
                statusElement.className = 'signature-status signed';
                statusElement.textContent = '✅ Signature captured successfully';
            }
        },

        isSignatureEmpty(canvas) {
            if (!canvas) return true;
            
            const ctx = canvas.getContext('2d');
            if (!ctx) return true;
            
            // Use a more efficient method to check if canvas is empty
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Check every 4th pixel (RGBA) for non-transparent pixels
            for (let i = 3; i < data.length; i += 4) {
                if (data[i] !== 0) { // Alpha channel not transparent
                    return false;
                }
            }
            return true;
        },

        validateSignature() {
            const canvas = document.getElementById('signaturePad');
            const isEmpty = this.isSignatureEmpty(canvas);
            
            if (isEmpty) {
                this.showSignatureError('Please provide your digital signature');
                return false;
            }
            
            this.clearSignatureError();
            return true;
        },

        showSignatureError(message) {
            const errorElement = document.getElementById('signature-error');
            errorElement.textContent = message;
            errorElement.classList.add('show');
        },

        clearSignatureError() {
            const errorElement = document.getElementById('signature-error');
            errorElement.classList.remove('show');
        },

        getSignatureData() {
            if (!state.signatureCanvas) {
                console.error('Signature canvas not available');
                return '';
            }
            return state.signatureCanvas.toDataURL();
        },

        /**
         * Clean up signature pad to prevent memory leaks
         */
        cleanupSignaturePad() {
            if (state.signatureCanvas) {
                // Remove all event listeners
                const canvas = state.signatureCanvas;
                canvas.replaceWith(canvas.cloneNode(true));
                
                // Clear timers
                if (state.statusUpdateTimer) {
                    clearTimeout(state.statusUpdateTimer);
                    state.statusUpdateTimer = null;
                }
                
                // Reset state
                state.isDrawing = false;
                state.lastX = 0;
                state.lastY = 0;
                state.lastDrawTime = null;
                state.signatureData = [];
                state.signaturePad = null;
                state.signatureCanvas = null;
            }
        },

        /**
         * Load product and stylist data from Google Sheets with caching and retry logic
         */
        async loadProducts() {
            const cacheKey = 'products_data';
            
            // Check cache first
            if (utils.isDataCached(cacheKey)) {
                const cachedData = utils.getCachedData(cacheKey);
                this.updateStateWithData(cachedData);
                this.setupAllAutocomplete();
                
                if (utils.isDevelopment()) {
                    console.log('Loaded data from cache');
                }
                return;
            }
            
            // Show loading state
            utils.showLoading('Loading salon data...');
            
            try {
                const data = await utils.retryWithBackoff(async () => {
                    const response = await fetch(CONFIG.CSV_URL, {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const csvText = await response.text();
                    return this.parseCSV(csvText);
                });
                
                // Cache the data
                utils.setCachedData(cacheKey, data);
                state.lastDataFetch = Date.now();
                
                // Update state with parsed data
                this.updateStateWithData(data);
                
                // Setup autocomplete after data is loaded
                this.setupAllAutocomplete();
                
                if (utils.isDevelopment()) {
                    console.log(`Loaded ${state.products.length} products, ${state.stylists.length} stylists, ${state.consultationIds.length} consultation IDs, ${state.saleProducts.length} sale products from Google Sheets`);
                }
                
                this.showToast('Data loaded successfully', 'success');
                
            } catch (error) {
                console.error('Failed to load data:', error);
                
                // Try to use cached data even if expired
                const cachedData = utils.getCachedData(cacheKey);
                if (cachedData) {
                    this.updateStateWithData(cachedData);
                    this.setupAllAutocomplete();
                    this.showToast('Using cached data. Some features may be limited.', 'error');
                } else {
                    // Initialize with empty data to prevent further errors
                    this.updateStateWithData({
                        products: [],
                        stylists: [],
                        consultationIds: [],
                        saleProducts: [],
                        salePrices: {}
                    });
                    this.setupAllAutocomplete();
                    this.showToast('Failed to load data. Autocomplete will be limited.', 'error');
                }
            } finally {
                utils.hideLoading();
            }
        },

        /**
         * Update state with parsed data
         * @param {Object} data - Parsed data object
         */
        updateStateWithData(data) {
            state.products = data.products || [];
            state.stylists = data.stylists || [];
            state.consultationIds = data.consultationIds || [];
            state.saleProducts = data.saleProducts || [];
            state.salePrices = data.salePrices || {};
        },

        /**
         * Setup all autocomplete functionality
         */
        setupAllAutocomplete() {
            this.setupAutocomplete();
            this.setupInitialUnitSuggestions();
            this.setupStylistAutocomplete();
            this.setupProductSaleAutocomplete();
            this.setupConsultationIdAutocomplete();
        },

        parseCSV(text) {
            const lines = text.trim().split('\n');
            const parsedProducts = [];
            const parsedStylists = [];
            const parsedConsultationIds = [];
            const parsedSaleProducts = [];
            const salePrices = {};
            let headerSkipped = false;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                // Simple CSV parsing - handles quoted fields
                const fields = [];
                let current = '';
                let inQuotes = false;
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        fields.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                fields.push(current.trim());
                // Skip header row (first row)
                if (!headerSkipped) {
                    headerSkipped = true;
                    continue;
                }
                // Column mapping: B=Product Name, C=Product Type, E=Unit, J=Stylist Name, R=Consultation ID, L=Sale Product Name, M=Sale Price
                // Note: New columns added for Sale Product Name, Stylist/Technician, Price, Total Price in consumption sheet
                const productName = fields[1] ? fields[1].replace(/^"|"$/g, '').trim() : '';
                const productType = fields[2] ? fields[2].replace(/^"|"$/g, '').trim() : '';
                const unit = fields[4] ? fields[4].replace(/^"|"$/g, '').trim() : '';
                const stylistName = fields[9] ? fields[9].replace(/^"|"$/g, '').trim() : '';
                const consultationId = fields[17] ? fields[17].replace(/^"|"$/g, '').trim() : '';
                const saleProductName = fields[11] ? fields[11].replace(/^"|"$/g, '').trim() : ''; // Column L (index 11)
                const salePrice = fields[12] ? fields[12].replace(/^"|"$/g, '').trim() : ''; // Column M (index 12)
                // Add product if valid
                if (productName && productType && productName !== 'Product Name') {
                    parsedProducts.push({ 
                        name: productName, 
                        type: productType, 
                        unit: unit || 'ml'
                    });
                }
                // Add stylist if valid and unique
                if (stylistName && stylistName.toLowerCase() !== 'stylist name' && !parsedStylists.includes(stylistName)) {
                    parsedStylists.push(stylistName);
                }
                // Add consultation ID if valid and unique
                if (consultationId && !parsedConsultationIds.includes(consultationId)) {
                    parsedConsultationIds.push(consultationId);
                }
                
                // Add sale product if valid and unique
                if (saleProductName && saleProductName !== 'Product Name' && saleProductName !== '' && !parsedSaleProducts.includes(saleProductName)) {
                    parsedSaleProducts.push(saleProductName);
                    console.log('Added sale product:', saleProductName);
                }
                
                // Add sale price if valid
                if (salePrice && salePrice !== 'Price (₹)' && salePrice !== '' && saleProductName) {
                    state.salePrices[saleProductName] = salePrice;
                    console.log('Added sale price for', saleProductName, ':', salePrice);
                } else if (saleProductName && (!salePrice || salePrice === 'Price (₹)' || salePrice === '')) {
                    console.log('Skipped sale price for', saleProductName, 'because salePrice was:', salePrice);
                }
            }
            console.log('Consultation IDs loaded:', parsedConsultationIds);
            console.log('Sale prices loaded:', state.salePrices);
            console.log('Sale products loaded:', parsedSaleProducts);
            return {
                products: parsedProducts,
                stylists: parsedStylists,
                consultationIds: parsedConsultationIds,
                saleProducts: parsedSaleProducts,
                salePrices: state.salePrices
            };
        },

        setupAutocomplete() {
            document.querySelectorAll('.product-name-input').forEach(input => {
                this.bindAutocomplete(input);
            });
        },

        setupStylistAutocomplete() {
            document.querySelectorAll('.stylist-name-input').forEach(input => {
                this.bindStylistAutocomplete(input);
            });
        },

        setupProductSaleAutocomplete() {
            console.log('Setting up Product Sale autocomplete');
            const saleProductInputs = document.querySelectorAll('.sale-product-name-input');
            console.log('Found sale product inputs:', saleProductInputs.length);
            saleProductInputs.forEach(input => {
                this.bindSaleProductAutocomplete(input);
            });
            document.querySelectorAll('.sale-stylist-name-input').forEach(input => {
                this.bindStylistAutocomplete(input);
            });
        },

        setupConsultationIdAutocomplete() {
            document.querySelectorAll('#consultationId').forEach(input => {
                this.bindConsultationIdAutocomplete(input);
            });
        },

        setupInitialUnitSuggestions() {
            document.querySelectorAll('.unit-input').forEach(input => {
                this.bindUnitSuggestions(input);
            });
        },

        /**
         * Bind autocomplete functionality to product name inputs
         * @param {HTMLInputElement} input - Input element to bind autocomplete to
         */
        bindAutocomplete(input) {
            const suggestionBox = input.nextElementSibling;
            const productEntry = input.closest('.product-entry');
            const productTypeInput = productEntry.querySelector('.product-type-input');
            const unitInput = productEntry.querySelector('.unit-input');
            
            // Debounced input handler for better performance
            const debouncedHandler = utils.debounce((e) => {
                const value = e.target.value.toLowerCase();
                suggestionBox.innerHTML = '';
                
                if (!value) {
                    suggestionBox.style.display = 'none';
                    return;
                }
                
                const matches = state.products
                    .filter(p => p.name.toLowerCase().includes(value))
                    .slice(0, 8);
                
                if (matches.length === 0) {
                    suggestionBox.style.display = 'none';
                    return;
                }
                
                matches.forEach(product => {
                    const option = document.createElement('div');
                    option.className = 'autocomplete-suggestion';
                    
                    const nameIndex = product.name.toLowerCase().indexOf(value);
                    let displayName = product.name;
                    if (nameIndex !== -1) {
                        const before = utils.sanitizeHtml(product.name.substring(0, nameIndex));
                        const highlight = utils.sanitizeHtml(product.name.substring(nameIndex, nameIndex + value.length));
                        const after = utils.sanitizeHtml(product.name.substring(nameIndex + value.length));
                        displayName = `${before}<strong>${highlight}</strong>${after}`;
                    }
                    
                    option.innerHTML = `${displayName}<span class="product-type">${utils.sanitizeHtml(product.type)}</span>`;
                    
                    option.addEventListener('click', () => {
                        input.value = product.name;
                        productTypeInput.value = product.type;
                        unitInput.value = product.unit;
                        suggestionBox.innerHTML = '';
                        suggestionBox.style.display = 'none';
                        
                        this.updateUnitSuggestions(unitInput, product);
                    });
                    
                    suggestionBox.appendChild(option);
                });
                
                suggestionBox.style.display = 'block';
            }, CONFIG.DEBOUNCE_DELAY, `autocomplete-${input.id || input.name}`);
            
            input.addEventListener('input', debouncedHandler);
            this.addKeyboardAndClickHandlers(input, suggestionBox);
        },

        bindSaleProductAutocomplete(input) {
            console.log('Setting up sale product autocomplete for:', input);
            const suggestionBox = input.nextElementSibling;
            const productSaleEntry = input.closest('.product-sale-entry');
            const priceInput = productSaleEntry.querySelector('.sale-price-input');
            
            input.addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase();
                console.log('Sale product input:', value);
                suggestionBox.innerHTML = '';
                
                if (!value) {
                    suggestionBox.style.display = 'none';
                    return;
                }
                
                // Check if saleProducts array exists
                if (!state.saleProducts || !Array.isArray(state.saleProducts)) {
                    console.warn('saleProducts array not available for autocomplete');
                    console.log('saleProducts:', state.saleProducts);
                    return;
                }
                
                const matches = state.saleProducts
                    .filter(name => name && name.toLowerCase().includes(value))
                    .slice(0, 8);
                
                if (matches.length === 0) {
                    suggestionBox.style.display = 'none';
                    return;
                }
                
                matches.forEach(productName => {
                    const option = document.createElement('div');
                    option.className = 'autocomplete-suggestion';
                    
                    const nameIndex = productName.toLowerCase().indexOf(value);
                    let displayName = productName;
                    if (nameIndex !== -1) {
                        displayName = productName.substring(0, nameIndex) + 
                                    '<strong>' + productName.substring(nameIndex, nameIndex + value.length) + '</strong>' +
                                    productName.substring(nameIndex + value.length);
                    }
                    
                    option.innerHTML = displayName;
                    
                    option.addEventListener('click', () => {
                        input.value = productName;
                        // Auto-fill price if available
                        if (state.salePrices && state.salePrices[productName] && priceInput) {
                            priceInput.value = state.salePrices[productName];
                            console.log(`Auto-filled price for ${productName}: ${state.salePrices[productName]}`);
                            // Trigger total calculation when price is auto-filled
                            this.updateSaleTotal();
                        } else {
                            console.log(`No price found for ${productName} in state.salePrices:`, state.salePrices);
                        }
                        suggestionBox.innerHTML = '';
                        suggestionBox.style.display = 'none';
                    });
                    
                    suggestionBox.appendChild(option);
                });
                
                suggestionBox.style.display = 'block';
            });
            
            this.addKeyboardAndClickHandlers(input, suggestionBox);
        },

        bindStylistAutocomplete(input) {
            const suggestionBox = input.nextElementSibling;
            
            input.addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase();
                suggestionBox.innerHTML = '';
                
                if (!value) {
                    suggestionBox.style.display = 'none';
                    return;
                }
                
                const matches = state.stylists
                    .filter(name => name.toLowerCase().includes(value))
                    .slice(0, 6);
                
                if (matches.length === 0) {
                    suggestionBox.style.display = 'none';
                    return;
                }
                
                matches.forEach(stylistName => {
                    const option = document.createElement('div');
                    option.className = 'autocomplete-suggestion';
                    
                    const nameIndex = stylistName.toLowerCase().indexOf(value);
                    let displayName = stylistName;
                    if (nameIndex !== -1) {
                        displayName = stylistName.substring(0, nameIndex) + 
                                    '<strong>' + stylistName.substring(nameIndex, nameIndex + value.length) + '</strong>' +
                                    stylistName.substring(nameIndex + value.length);
                    }
                    
                    option.innerHTML = displayName;
                    
                    option.addEventListener('click', () => {
                        input.value = stylistName;
                        suggestionBox.innerHTML = '';
                        suggestionBox.style.display = 'none';
                    });
                    
                    suggestionBox.appendChild(option);
                });
                
                suggestionBox.style.display = 'block';
            });
            
            this.addKeyboardAndClickHandlers(input, suggestionBox);
        },

        bindConsultationIdAutocomplete(input) {
            const suggestionBox = input.nextElementSibling;
            
            input.addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase();
                suggestionBox.innerHTML = '';
                
                if (!value) {
                    suggestionBox.style.display = 'none';
                    return;
                }
                
                const matches = state.consultationIds
                    .filter(id => id.toLowerCase().includes(value))
                    .slice(0, 6);
                
                if (matches.length === 0) {
                    suggestionBox.style.display = 'none';
                    return;
                }
                
                matches.forEach(id => {
                    const option = document.createElement('div');
                    option.className = 'autocomplete-suggestion';
                    
                    const idIndex = id.toLowerCase().indexOf(value);
                    let displayName = id;
                    if (idIndex !== -1) {
                        displayName = id.substring(0, idIndex) + 
                                    '<strong>' + id.substring(idIndex, idIndex + value.length) + '</strong>' +
                                    id.substring(idIndex + value.length);
                    }
                    
                    option.innerHTML = displayName;
                    
                    option.addEventListener('click', () => {
                        input.value = id;
                        suggestionBox.innerHTML = '';
                        suggestionBox.style.display = 'none';
                    });
                    
                    suggestionBox.appendChild(option);
                });
                
                suggestionBox.style.display = 'block';
            });
            
            this.addKeyboardAndClickHandlers(input, suggestionBox);
        },

        addKeyboardAndClickHandlers(input, suggestionBox) {
            input.addEventListener('keydown', (e) => {
                const suggestions = suggestionBox.querySelectorAll('.autocomplete-suggestion');
                if (e.key === 'Enter' && suggestions.length > 0) {
                    e.preventDefault();
                    suggestions[0].click();
                } else if (e.key === 'Escape') {
                    suggestionBox.style.display = 'none';
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestionBox.contains(e.target)) {
                    suggestionBox.style.display = 'none';
                }
            });
        },

        bindUnitSuggestions(unitInput) {
            const unitPills = unitInput.nextElementSibling;
            this.updateUnitSuggestions(unitInput, null);
            
            unitInput.addEventListener('focus', () => {
                unitPills.style.display = 'flex';
            });
        },

        updateUnitSuggestions(unitInput, selectedProduct) {
            const unitPills = unitInput.nextElementSibling;
            unitPills.innerHTML = '';
            
            const allUnits = [...new Set(state.products.map(p => p.unit).filter(Boolean))];
            
            let suggestedUnits = [];
            if (selectedProduct && selectedProduct.unit) {
                suggestedUnits = [selectedProduct.unit];
                allUnits.forEach(unit => {
                    if (!suggestedUnits.includes(unit)) {
                        suggestedUnits.push(unit);
                    }
                });
            } else {
                suggestedUnits = allUnits;
            }
            
            suggestedUnits.slice(0, 8).forEach((unit, index) => {
                const pill = document.createElement('button');
                pill.type = 'button';
                pill.className = 'unit-pill';
                pill.textContent = unit;
                
                if (selectedProduct && unit === selectedProduct.unit) {
                    pill.classList.add('exact-match');
                }
                
                pill.addEventListener('click', (e) => {
                    e.preventDefault();
                    unitInput.value = unit;
                    unitPills.style.display = 'none';
                });
                
                unitPills.appendChild(pill);
            });
        },

        setInitialDate() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const nextMonth = new Date(today);
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            
            const visitDateInput = document.getElementById('visitDate');
            visitDateInput.valueAsDate = today;
            visitDateInput.min = yesterday.toISOString().split('T')[0];
            visitDateInput.max = nextMonth.toISOString().split('T')[0];
        },

        bindEvents() {
            const form = document.getElementById('salonForm');
            form.addEventListener('submit', this.handleSubmit.bind(this));
            
            document.getElementById('addProductBtn').addEventListener('click', () => {
                this.addProductEntry();
            });
            
            document.getElementById('addStylistBtn').addEventListener('click', () => {
                this.addStylistEntry();
            });
            
            document.getElementById('addProductSaleBtn').addEventListener('click', () => {
                this.addProductSaleEntry();
            });
            
            document.querySelectorAll('.stylist-incentive-input').forEach(input => {
                input.addEventListener('input', this.updateTotalCost.bind(this));
            });
            
            document.getElementById('stylistContainer').addEventListener('input', (e) => {
                if (e.target && e.target.classList.contains('stylist-incentive-input')) {
                    this.updateTotalCost();
                }
            });

            // Add event listeners for sale price inputs
            document.querySelectorAll('.sale-price-input').forEach(input => {
                input.addEventListener('input', this.updateSaleTotal.bind(this));
            });
            
            document.getElementById('productSaleContainer').addEventListener('input', (e) => {
                if (e.target && e.target.classList.contains('sale-price-input')) {
                    this.updateSaleTotal();
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.field')) {
                    document.querySelectorAll('.unit-pills').forEach(pills => {
                        pills.style.display = 'none';
                    });
                    document.querySelectorAll('.autocomplete-suggestions').forEach(suggestions => {
                        suggestions.style.display = 'none';
                    });
                }
            });
            
            form.addEventListener('input', this.clearFieldError.bind(this));
            form.addEventListener('change', this.clearFieldError.bind(this));
        },

        addProductEntry() {
            const container = document.getElementById('productContainer');
            const template = document.getElementById('productTemplate');
            const clone = document.importNode(template.content, true);
            
            container.appendChild(clone);
            
            const addedEntry = container.lastElementChild;
            const newProductInput = addedEntry.querySelector('.product-name-input');
            const newUnitInput = addedEntry.querySelector('.unit-input');
            
            this.bindAutocomplete(newProductInput);
            this.bindUnitSuggestions(newUnitInput);
            // DEBUG LOGS
            console.log('Added product row:', addedEntry);
            console.log('All .remove-product-btn:', document.querySelectorAll('.remove-product-btn'));
        },

        addStylistEntry() {
            const container = document.getElementById('stylistContainer');
            const template = document.getElementById('stylistTemplate');
            const clone = document.importNode(template.content, true);
            
            const count = container.querySelectorAll('.stylist-entry').length;
            const inputs = clone.querySelectorAll('input');
            inputs.forEach((input, index) => {
                if (input.type === 'text') {
                    input.id = `stylistName${count}`;
                } else if (input.type === 'number') {
                    input.id = `incentiveSplit${count}`;
                }
            });
            
            container.appendChild(clone);
            
            const addedEntry = container.lastElementChild;
            const newStylistInput = addedEntry.querySelector('.stylist-name-input');
            this.bindStylistAutocomplete(newStylistInput);
            
            this.updateTotalCost();
            // DEBUG LOGS
            console.log('Added stylist row:', addedEntry);
            console.log('All .remove-stylist-btn:', document.querySelectorAll('.remove-stylist-btn'));
        },

        addProductSaleEntry() {
            const container = document.getElementById('productSaleContainer');
            const template = document.getElementById('productSaleTemplate');
            const clone = document.importNode(template.content, true);
            
            container.appendChild(clone);
            
            const addedEntry = container.lastElementChild;
            const newProductInput = addedEntry.querySelector('.sale-product-name-input');
            const newStylistInput = addedEntry.querySelector('.sale-stylist-name-input');
            
            this.bindSaleProductAutocomplete(newProductInput);
            this.bindStylistAutocomplete(newStylistInput);
            
            // Add event listener for the new sale price input
            const newPriceInput = addedEntry.querySelector('.sale-price-input');
            if (newPriceInput) {
                newPriceInput.addEventListener('input', this.updateSaleTotal.bind(this));
            }
            
            // DEBUG LOGS
            console.log('Added product sale row:', addedEntry);
            console.log('All .remove-product-sale-btn:', document.querySelectorAll('.remove-product-sale-btn'));
        },

        updateTotalCost() {
            const incentiveInputs = document.querySelectorAll('.stylist-incentive-input');
            let total = 0;
            incentiveInputs.forEach(input => {
                const val = parseFloat(input.value);
                if (!isNaN(val)) {
                    total += val;
                }
            });
            document.getElementById('totalCost').value = total.toFixed(2);
        },

        updateSaleTotal() {
            const salePriceInputs = document.querySelectorAll('.sale-price-input');
            let total = 0;
            salePriceInputs.forEach(input => {
                const val = parseFloat(input.value);
                if (!isNaN(val)) {
                    total += val;
                }
            });
            const saleTotalInput = document.querySelector('.sale-total-input');
            if (saleTotalInput) {
                saleTotalInput.value = total.toFixed(2);
            }
            console.log('Updated sale total:', total.toFixed(2));
        },

        /**
         * Validate individual form field
         * @param {HTMLInputElement|HTMLSelectElement|HTMLTextAreaElement} field - Field to validate
         * @returns {boolean} Is field valid
         */
        validateField(field) {
            const value = field.value.trim();
            let isValid = true;
            let errorMessage = '';

            field.classList.remove('error');
            
            if (field.hasAttribute('required') && !value) {
                isValid = false;
                errorMessage = `${this.getFieldLabel(field)} is required`;
            } else if (field.type === 'email' && value && !utils.isValidEmail(value)) {
                isValid = false;
                errorMessage = 'Please enter a valid email address';
            } else if (field.type === 'tel' && value && !utils.isValidPhone(value)) {
                isValid = false;
                errorMessage = 'Please enter a valid phone number';
            }

            if (!isValid) {
                this.showFieldError(field, errorMessage);
            }

            return isValid;
        },

        validateServices() {
            const services = document.querySelectorAll('input[name="services"]:checked');
            if (services.length === 0) {
                this.showFieldError(document.querySelector('input[name="services"]'), 'Please select at least one service');
                return false;
            }
            return true;
        },

        validateConsent() {
            const consent = document.querySelector('input[name="consent"]:checked');
            if (!consent) {
                this.showFieldError(document.querySelector('input[name="consent"]'), 'Please select your consent preference');
                return false;
            }
            return true;
        },

        showFieldError(field, message) {
            field.classList.add('error');
            const errorElement = document.getElementById(`${field.id || field.name}-error`) || 
                               document.getElementById('services-error') ||
                               document.getElementById('consent-error');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }
        },

        clearFieldError(e) {
            const field = e.target;
            field.classList.remove('error');
            const errorElement = document.getElementById(`${field.id || field.name}-error`);
            if (errorElement) {
                errorElement.classList.remove('show');
            }
            
            if (field.name === 'services') {
                const servicesError = document.getElementById('services-error');
                if (servicesError) {
                    servicesError.classList.remove('show');
                }
            }
            
            if (field.name === 'consent') {
                const consentError = document.getElementById('consent-error');
                if (consentError) {
                    consentError.classList.remove('show');
                }
            }
        },

        getFieldLabel(field) {
            const label = document.querySelector(`label[for="${field.id}"]`);
            return label ? label.textContent.replace('*', '').trim() : field.name;
        },

        isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        },

        /**
         * Handle form submission with improved validation, loading states, and enhanced Google Sheets integration
         * @param {Event} e - Form submit event
         */
        async handleSubmit(e) {
            e.preventDefault();
            
            const form = e.target;
            const submitButton = form.querySelector('.btn-submit');
            const formType = form.id === 'salonForm' ? 'consultation' : 'consumption';
            
            // Prevent double submission
            if (state.isFormSubmitting) {
                return;
            }
            
            // Show button loading state
            utils.showButtonLoading(submitButton, 'Validating...');
            state.isFormSubmitting = true;
            
            let isValid = true;
            
            // Validate consent first (only for consultation form)
            if (formType === 'consultation') {
                if (!this.validateConsent()) {
                    isValid = false;
                }
                
                // Validate signature (only for consultation form)
                if (!this.validateSignature()) {
                    isValid = false;
                }
            }
            
            // Validate required fields
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!this.validateField(field)) {
                    isValid = false;
                }
            });
            
            // Validate email if provided
            const emailField = document.getElementById('email');
            if (emailField && emailField.value && !this.validateField(emailField)) {
                isValid = false;
            }
            
            // Validate services (only for consultation form)
            if (formType === 'consultation' && !this.validateServices()) {
                isValid = false;
            }
            
            if (!isValid) {
                utils.hideButtonLoading(submitButton);
                this.resetSubmitButton(submitButton, formType);
                this.showToast('Please fix the errors above', 'error');
                state.isFormSubmitting = false;
                return;
            }
            
            // Update button text for submission
            utils.showButtonLoading(submitButton, 'Preparing data...');
            
            // Generate unique Submit ID
            const submitId = utils.generateSubmitId();
            
            // Show Submit ID to user
            const submitIdDisplay = formType === 'consultation' ? 
                document.getElementById('submitIdDisplay') : 
                document.getElementById('submitIdDisplay2');
            submitIdDisplay.textContent = `Submit ID: ${submitId}`;
            submitIdDisplay.style.display = 'block';
            
            // Collect form data
            const formData = new FormData(form);
            const data = this.processFormData(formData);
            
            // Add form type and unique Submit ID
            data.formType = formType;
            data.submitId = submitId;
            data.timestamp = new Date().toISOString();
            data.userAgent = navigator.userAgent;
            data.screenSize = `${window.screen.width}x${window.screen.height}`;
            
            // Add signature data and photos based on form type
            if (formType === 'consultation') {
                data.clientSignature = this.getSignatureData();
                data.beforePhoto = state.beforePhotoData;
            } else if (formType === 'consumption') {
                data.afterPhoto = state.afterPhotoData;
            }
            
            if (utils.isDevelopment()) {
                console.log(`Sending ${formType} data to Google Sheets with Submit ID:`, submitId, data);
            }
            
            // Update button text for actual submission
            utils.showButtonLoading(submitButton, 'Saving to Google Sheets...');
            
            try {
                // Enhanced Google Sheets submission with retry logic
                await utils.retryWithBackoff(async () => {
                    const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: 'formData=' + encodeURIComponent(JSON.stringify(data))
                    });
                    
                    // Since we're using no-cors, we can't check response status
                    // But we can assume success if no error is thrown
                    return response;
                });
                
                // Show success message
                this.showSuccessMessage(formType, submitId, data);
                
                // Reset form after a short delay
                setTimeout(() => {
                    this.resetForm(form, formType);
                }, 1000);
                
                // Keep Submit ID visible for reference
                submitIdDisplay.textContent = `✅ Last Submit ID: ${submitId}`;
                
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                this.showFallbackMessage(formType, submitId, data);
            } finally {
                utils.hideButtonLoading(submitButton);
                this.resetSubmitButton(submitButton, formType);
                state.isFormSubmitting = false;
            }
        },

        processFormData(formData) {
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                if (key.endsWith('[]')) {
                    const arrayKey = key.slice(0, -2);
                    if (!data[arrayKey]) data[arrayKey] = [];
                    data[arrayKey].push(value);
                } else {
                    data[key] = value;
                }
            }
            
            const services = [];
            document.querySelectorAll('input[name="services"]:checked').forEach(cb => {
                services.push(cb.value);
            });
            data.services = services;
            
            return data;
        },

        /**
         * Reset submit button to original state
         * @param {HTMLButtonElement} button - Submit button
         * @param {string} formType - Form type
         */
        resetSubmitButton(button, formType) {
            button.classList.remove('loading');
            button.innerHTML = formType === 'consultation' ? 
                '<span class="icon">💾</span> Save Client Record' : 
                '<span class="icon">💾</span> Save Consumption Record';
        },

        /**
         * Show success message for form submission
         * @param {string} formType - Form type
         * @param {string} submitId - Submit ID
         * @param {Object} data - Form data
         */
        showSuccessMessage(formType, submitId, data) {
            if (formType === 'consultation') {
                this.showToast(`✅ Client Consultation saved successfully! 📋\nSubmit ID: ${submitId}\nClient: ${data.clientName || 'N/A'}`, 'success');
            } else if (formType === 'consumption') {
                this.showToast(`✅ Consumption Record saved successfully! 📊\nSubmit ID: ${submitId}\nConsultation ID: ${data.consultationId || 'N/A'}`, 'success');
            }
        },

        /**
         * Show fallback message when submission fails
         * @param {string} formType - Form type
         * @param {string} submitId - Submit ID
         * @param {Object} data - Form data
         */
        showFallbackMessage(formType, submitId, data) {
            if (formType === 'consultation') {
                this.showToast(`⚠️ Client Consultation submitted (ID: ${submitId})\nPlease verify in Google Sheets\nClient: ${data.clientName || 'N/A'}`, 'success');
            } else if (formType === 'consumption') {
                this.showToast(`⚠️ Consumption Record submitted (ID: ${submitId})\nPlease verify in Google Sheets\nConsultation ID: ${data.consultationId || 'N/A'}`, 'success');
            }
            
            if (utils.isDevelopment()) {
                console.log(`${formType} Form Data (fallback):`, data);
            }
        },

        /**
         * Reset form after successful submission
         * @param {HTMLFormElement} form - Form element
         * @param {string} formType - Form type
         */
        resetForm(form, formType) {
            form.reset();
            if (formType === 'consultation') {
                this.setInitialDate();
                this.updateTotalCost();
                this.clearSignature();
                this.removePhotoSilently('before');
                this.removePhotoSilently('after');
            } else if (formType === 'consumption') {
                this.removePhotoSilently('after');
            }
        },

        /**
         * Show toast notification
         * @param {string} message - Message to display
         * @param {string} type - Toast type ('success' or 'error')
         */
        showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, CONFIG.TOAST_DURATION);
        },

        /**
         * Cleanup function for performance optimizations
         */
        cleanup() {
            // Disconnect observers
            if (state.intersectionObserver) {
                state.intersectionObserver.disconnect();
            }
            if (state.resizeObserver) {
                state.resizeObserver.disconnect();
            }
            
            // Clear timers
            if (state.statusUpdateTimer) {
                clearTimeout(state.statusUpdateTimer);
            }
            
            // Clear debounce timers
            state.debounceTimers.forEach(timer => {
                clearTimeout(timer);
            });
            state.debounceTimers.clear();
            
            // Cleanup signature pad
            this.cleanupSignaturePad();
            
            // Clear data cache
            state.dataCache.clear();
        }
    };

    // Expose SalonForm globally
    window.SalonForm = SalonForm;
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => SalonForm.init());
    } else {
        SalonForm.init();
    }
})();

// Form navigation script
(function() {
    'use strict';
    
    /**
     * Initialize form navigation
     */
    function initFormNavigation() {
        const consultationBtn = document.getElementById('show-client-consultation');
        const consumptionBtn = document.getElementById('show-consumption-form');
        const consumptionForm = document.getElementById('consumptionForm');
        
        if (consultationBtn) {
            consultationBtn.addEventListener('click', showConsultationForm);
        }
        
        if (consumptionBtn) {
            consumptionBtn.addEventListener('click', showConsumptionForm);
        }
        
        if (consumptionForm) {
            consumptionForm.addEventListener('submit', SalonForm.handleSubmit.bind(SalonForm));
        }
    }
    
    /**
     * Show consultation form
     */
    function showConsultationForm() {
        document.getElementById('form-chooser').style.display = 'none';
        document.getElementById('client-consultation-section').style.display = 'block';
        document.getElementById('consumption-form-section').style.display = 'none';
        
        // Initialize signature pad with delay to ensure DOM is ready
        if (window.SalonForm && typeof SalonForm.initSignaturePad === 'function') {
            setTimeout(() => SalonForm.initSignaturePad(), 300);
        }
    }
    
    /**
     * Show consumption form
     */
    function showConsumptionForm() {
        document.getElementById('form-chooser').style.display = 'none';
        document.getElementById('client-consultation-section').style.display = 'none';
        document.getElementById('consumption-form-section').style.display = 'block';
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFormNavigation);
    } else {
        initFormNavigation();
    }
})();
</script>
</body>
</html>
